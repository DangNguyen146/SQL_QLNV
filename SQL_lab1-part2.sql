create database lab1_1
go
use lab1_1

CREATE TABLE KHACHHANG(
	MAKH CHAR(4) NOT NULL,
	HOTEN VARCHAR(40),
	DCHI VARCHAR(50),
	SODT VARCHAR(20),
	NGSINH	DATE,
	DOANHSO MONEY,
	NGDK DATE
)

CREATE TABLE NHANVIEN (
	MANV CHAR(4) NOT NULL,
	HOTEN VARCHAR(40),
	SODT VARCHAR(20),
	NGVL DATE
)

CREATE TABLE SANPHAM (
	MASP CHAR(4),
	TENSP VARCHAR(40),
	DVT VARCHAR(20),
	NUOCSX VARCHAR(40),
	GIA MONEY
)


CREATE TABLE HOADON (
	SOHD INT NOT NULL,
	NGHD DATE,
	MAKH CHAR(4), 
	MANV CHAR(4),
	TRIGIA MONEY
)

CREATE TABLE CTHD (
	SOHD INT,
	MASP CHAR(4),
	SL INT
)

INSERT INTO dbo.NHANVIEN VALUES('NV01','Nguyen Nhu Nhut', '0927345678', '20060413')
INSERT INTO dbo.NHANVIEN VALUES('NV02','Le Thi Phi Yen', '0987567390', '20060421')
INSERT INTO dbo.NHANVIEN VALUES('NV03','Nguyen Van B', '0997047382', '20060427')
INSERT INTO dbo.NHANVIEN VALUES('NV04','Ngo Thanh Tuan', '0913758498', '20060424')
INSERT INTO dbo.NHANVIEN VALUES('NV05','Nguyen Thi Truc Thanh', '0918590389', '20060420')

INSERT INTO dbo.KHACHHANG VALUES('KH01', 'Nguyen Van A', '731 Tran Hung Dao, Q5, TpHCM', '08823451', '19601022', 13060000, '20060722')
INSERT INTO dbo.KHACHHANG VALUES('KH02', 'Tran Ngoc Han', '23/5 Nguyen Trai, Q5, TpHCM', '0908256478', '19740403', 280000, '20060730')
INSERT INTO dbo.KHACHHANG VALUES('KH03', 'Tran Ngoc Linh', '45 Nguyen Canh Chan, Q1, TpHCM', '0938776266', '19800612', 3860000, '20060805')
INSERT INTO dbo.KHACHHANG VALUES('KH04', 'Tran Minh Long', '50/34 Le Dai Hanh, Q10, TpHCM', '0917325476', '19650309', 250000, '20061002')
INSERT INTO dbo.KHACHHANG VALUES('KH05', 'Le Nhat Minh', '34 Truong Dinh, Q3, TpHCM', '08246108', '19500310', 21000, '20061028')
INSERT INTO dbo.KHACHHANG VALUES('KH06', 'Le Hoai Thuong', '227 Nguyen Van Cu, Q5, TpHCM', '08631708', '19811231', 915000, '20061124')
INSERT INTO dbo.KHACHHANG VALUES('KH07', 'Nguyen Van Tam', '32/3 Tran Binh Trong, Q5, TpHCM', '0916783565', '19710406', 12500, '20061201')
INSERT INTO dbo.KHACHHANG VALUES('KH08', 'Pham Thi Thanh', '45/2 An Duong Vuong, Q5, TpHCM', '0938435756', '19710110', 365000, '20061213')
INSERT INTO dbo.KHACHHANG VALUES('KH09', 'Le Ha Vinh', '873 Le Hong Phong, Q5, TpHCM', '08654763', '19790903', 70000, '20070114')
INSERT INTO dbo.KHACHHANG VALUES('KH10', 'Ha Duy Lap', '34/34B Nguyen Trai, Q1, TpHCM', '08768904', '19830502', 67500, '20070116')

INSERT INTO dbo.SANPHAM VALUES('BC01', 'But chi', 'cay', 'Singapore', 3000)
INSERT INTO dbo.SANPHAM VALUES('BC02', 'But chi', 'cay', 'Singapore', 5000)
INSERT INTO dbo.SANPHAM VALUES('BC03', 'But chi', 'cay', 'Viet Nam', 3500)
INSERT INTO dbo.SANPHAM VALUES('BC04', 'But chi', 'hop', 'Viet Nam', 30000)
INSERT INTO dbo.SANPHAM VALUES('BB01', 'But bi', 'cay', 'Viet Nam', 5000)
INSERT INTO dbo.SANPHAM VALUES('BB02', 'But bi', 'cay', 'Trung Quoc', 7000)
INSERT INTO dbo.SANPHAM VALUES('BB03', 'But bi', 'hop', 'Thai Lan', 100000)
INSERT INTO dbo.SANPHAM VALUES('TV01', 'Tap 100 giay mong', 'quyen', 'Viet Nam', 2500)
INSERT INTO dbo.SANPHAM VALUES('TV02', 'Tap 200 giay mong', 'quyen', 'Viet Nam', 4500)
INSERT INTO dbo.SANPHAM VALUES('TV03', 'Tap 100 giay tot', 'quyen', 'Viet Nam', 3000)
INSERT INTO dbo.SANPHAM VALUES('TV04', 'Tap 200 giay tot', 'quyen', 'Viet Nam', 5500)
INSERT INTO dbo.SANPHAM VALUES('TV05', 'Tap 100 trang', 'chuc', 'Viet Nam', 23000)
INSERT INTO dbo.SANPHAM VALUES('TV06', 'Tap 200 trang', 'chuc', 'Viet Nam', 53000)
INSERT INTO dbo.SANPHAM VALUES('TV07', 'Tap 100 trang', 'chuc', 'Trung Quoc', 34000)
INSERT INTO dbo.SANPHAM VALUES('ST01', 'So tay 500 trang', 'quyen', 'Trung Quoc', 40000)
INSERT INTO dbo.SANPHAM VALUES('ST02', 'So tay loai 1', 'quyen', 'Viet Nam', 55000)
INSERT INTO dbo.SANPHAM VALUES('ST03', 'So tay loai 2', 'quyen', 'Viet Nam', 51000)
INSERT INTO dbo.SANPHAM VALUES('ST04', 'So tay', 'quyen', 'Thai Lan', 550000)
INSERT INTO dbo.SANPHAM VALUES('ST05', 'So tay mong', 'quyen', 'Thai Lan', 20000)
INSERT INTO dbo.SANPHAM VALUES('ST06', 'Phan viet bang', 'hop', 'Viet Nam', 5000)
INSERT INTO dbo.SANPHAM VALUES('ST07', 'Phan khong bui', 'hop', 'Viet Nam', 7000)
INSERT INTO dbo.SANPHAM VALUES('ST08', 'Bong bang', 'cai', 'Viet Nam', 1000)
INSERT INTO dbo.SANPHAM VALUES('ST09', 'But long', 'cay', 'Viet Nam', 5000)
INSERT INTO dbo.SANPHAM VALUES('ST10', 'But long', 'cay', 'Trung Quoc', 7000)

INSERT INTO dbo.HOADON VALUES('1001', '20060723', 'KH01', 'NV01', 32000)
INSERT INTO dbo.HOADON VALUES('1002', '20060812', 'KH01', 'NV02', 84000)
INSERT INTO dbo.HOADON VALUES('1003', '20060823', 'KH02', 'NV01', 10000)
INSERT INTO dbo.HOADON VALUES('1004', '20060901', 'KH02', 'NV01', 18000)
INSERT INTO dbo.HOADON VALUES('1005', '20061020', 'KH01', 'NV02', 3800000)
INSERT INTO dbo.HOADON VALUES('1006', '20061016', 'KH01', 'NV03', 2430000)
INSERT INTO dbo.HOADON VALUES('1007', '20061028', 'KH03', 'NV03', 51000)
INSERT INTO dbo.HOADON VALUES('1008', '20061028', 'KH01', 'NV03', 44000)
INSERT INTO dbo.HOADON VALUES('1009', '20060723', 'KH03', 'NV04', 20000)
INSERT INTO dbo.HOADON VALUES('1010', '20061101', 'KH01', 'NV01', 5200000)
INSERT INTO dbo.HOADON VALUES('1011', '20061104', 'KH04', 'NV03', 250000)
INSERT INTO dbo.HOADON VALUES('1012', '20061130', 'KH05', 'NV03', 21000)
INSERT INTO dbo.HOADON VALUES('1013', '20061212', 'KH06', 'NV01', 5000)
INSERT INTO dbo.HOADON VALUES('1014', '20061231', 'KH03', 'NV02', 3150000)
INSERT INTO dbo.HOADON VALUES('1015', '20070101', 'KH06', 'NV01', 910000)
INSERT INTO dbo.HOADON VALUES('1016', '20070101', 'KH07', 'NV02', 12500)
INSERT INTO dbo.HOADON VALUES('1017', '20070102', 'KH08', 'NV03', 35000)
INSERT INTO dbo.HOADON VALUES('1018', '20070113', 'KH08', 'NV03', 330000)
INSERT INTO dbo.HOADON VALUES('1019', '20070113', 'KH01', 'NV03', 30000)
INSERT INTO dbo.HOADON VALUES('1020', '20070114', 'KH09', 'NV04', 70000)
INSERT INTO dbo.HOADON VALUES('1021', '20070116', 'KH10', 'NV03', 67500)
INSERT INTO dbo.HOADON VALUES('1022', '20070116', NULL, 'NV03', 7000)
INSERT INTO dbo.HOADON VALUES('1023', '20070117', NULL, 'NV01', 330000)

INSERT INTO dbo.CTHD VALUES('1001', 'TV02', 10)
INSERT INTO dbo.CTHD VALUES('1001', 'ST01', 5)
INSERT INTO dbo.CTHD VALUES('1001', 'BC01', 5)
INSERT INTO dbo.CTHD VALUES('1001', 'BC02', 10)
INSERT INTO dbo.CTHD VALUES('1001', 'ST08', 10)
INSERT INTO dbo.CTHD VALUES('1002', 'BC04', 20)
INSERT INTO dbo.CTHD VALUES('1002', 'BB01', 20)
INSERT INTO dbo.CTHD VALUES('1002', 'BB02', 20)
INSERT INTO dbo.CTHD VALUES('1003', 'BB03', 10)
INSERT INTO dbo.CTHD VALUES('1004', 'TV01', 20)
INSERT INTO dbo.CTHD VALUES('1004', 'TV02', 10)
INSERT INTO dbo.CTHD VALUES('1004', 'TV03', 10)
INSERT INTO dbo.CTHD VALUES('1004', 'TV04', 10)
INSERT INTO dbo.CTHD VALUES('1005', 'TV05', 50)
INSERT INTO dbo.CTHD VALUES('1005', 'TV06', 50)
INSERT INTO dbo.CTHD VALUES('1006', 'TV07', 20)
INSERT INTO dbo.CTHD VALUES('1006', 'ST01', 30)
INSERT INTO dbo.CTHD VALUES('1006', 'ST02', 10)
INSERT INTO dbo.CTHD VALUES('1007', 'ST03', 10)
INSERT INTO dbo.CTHD VALUES('1008', 'ST04', 8)
INSERT INTO dbo.CTHD VALUES('1009', 'ST05', 10)
INSERT INTO dbo.CTHD VALUES('1010', 'TV07', 50)
INSERT INTO dbo.CTHD VALUES('1010', 'ST07', 50)
INSERT INTO dbo.CTHD VALUES('1010', 'ST08', 100)
INSERT INTO dbo.CTHD VALUES('1010', 'ST04', 50)
INSERT INTO dbo.CTHD VALUES('1010', 'TV03', 100)
INSERT INTO dbo.CTHD VALUES('1011', 'ST06', 50)
INSERT INTO dbo.CTHD VALUES('1012', 'ST07', 3)
INSERT INTO dbo.CTHD VALUES('1013', 'ST08', 5)
INSERT INTO dbo.CTHD VALUES('1014', 'BC02',	80)
INSERT INTO dbo.CTHD VALUES('1014', 'BB02', 100)
INSERT INTO dbo.CTHD VALUES('1014', 'BC04', 60)
INSERT INTO dbo.CTHD VALUES('1014', 'BB01', 50)
INSERT INTO dbo.CTHD VALUES('1015', 'BB02', 30)
INSERT INTO dbo.CTHD VALUES('1015', 'BB03', 7)
INSERT INTO dbo.CTHD VALUES('1016', 'TV01', 5)
INSERT INTO dbo.CTHD VALUES('1017', 'TV02', 1)
INSERT INTO dbo.CTHD VALUES('1017', 'TV03', 1)
INSERT INTO dbo.CTHD VALUES('1017', 'TV04', 5)
INSERT INTO dbo.CTHD VALUES('1018', 'ST04', 6)
INSERT INTO dbo.CTHD VALUES('1019', 'ST05', 1)
INSERT INTO dbo.CTHD VALUES('1019', 'ST06', 2)
INSERT INTO dbo.CTHD VALUES('1020', 'ST07', 10)
INSERT INTO dbo.CTHD VALUES('1021', 'ST08', 5)
INSERT INTO dbo.CTHD VALUES('1021', 'TV01', 7)
INSERT INTO dbo.CTHD VALUES('1021', 'TV02', 10)
INSERT INTO dbo.CTHD VALUES('1022', 'ST07', 1)
INSERT INTO dbo.CTHD VALUES('1023', 'ST04', 6)

go
--Khóa chính
alter table dbo.KHACHHANG add constraint FK_KH primary key(MAKH)	
alter table dbo.NHANVIEN add constraint FK_NV primary key(MANV)
--chỉnh lại kiểu dữ liệu cho sản phẩm
alter table dbo.SANPHAM alter column MASP CHAR(4) not null
go
alter table dbo.SANPHAM add constraint FK_SP primary key(MASP)
alter table dbo.HOADON add  constraint KH_HD primary key(SOHD)

--Khóa phụ
alter table dbo.HOADON add constraint KP_KH foreign key(MAKH) references dbo.KHACHHANG
alter table dbo.HOADON add constraint KP_NV foreign key(MANV) references dbo.NHANVIEN
alter table dbo.CTHD add constraint KH_SP foreign key(MASP) references dbo.SANPHAM
alter table dbo.CTHD add constraint KP_HD foreign key(SOHD) references dbo.HOADON

alter table dbo.SANPHAM add GHICHU varchar(20)
alter table dbo.KHACHHANG add MASP CHAR(4)
update dbo.KHACHHANG set HOTEN='Nguyễn Văn B' where MAKH='KH01' 
update dbo.KHACHHANG set HOTEN='Nguyễn Văn Hoan' WHERE MAKH='KH09' AND YEAR(NGDK)=2007

alter table dbo.SANPHAM alter column GHICHU varchar(100)
alter table dbo.SANPHAM drop column GHICHU

--Để xóa được thì: KhachHang -> HoaDon -> CTHD
delete from dbo.CTHD where CTHD.SOHD in (select SOHD from KHACHHANG where YEAR(NGSINH)=1971)
delete from dbo.HOADON where HOADON.MAKH in (select MAKH from KHACHHANG where year(NGSINH)=1971)
delete from dbo.KHACHHANG where YEAR(NGSINH)=1971 

--Để xóa được thì: KhachHang -> HoaDon -> CTHD
delete from dbo.CTHD where CTHD.SOHD IN(SELECT SOHD FROM KHACHHANG WHERE YEAR(KHACHHANG.NGDK)=2006)
DELETE FROM dbo.HOADON where HOADON.SOHD IN( SELECT SOHD FROM KHACHHANG WHERE YEAR(KHACHHANG.NGDK)=2006)
delete from dbo.KHACHHANG where (YEAR(KHACHHANG.NGDK)=2006)

--Để xóa được thì: CTHD -> HoaDon
DELETE FROM CTHD WHERE CTHD.SOHD IN (SELECT SOHD FROM HOADON WHERE MAKH='KH01')
delete from dbo.HOADON where MAKH='KH01'